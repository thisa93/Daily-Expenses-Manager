<%- include('../partials/header') %>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card mt-4">
                <div class="card-header">Edit Transaction</div>
                <div class="card-body">
                    <form action="/transactions/edit/<%= transaction._id %>" method="POST">
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" name="type" id="type" onchange="toggleFields()">
                                <option value="expense" <%=transaction.type==='expense' ? 'selected' : '' %>>Expense
                                </option>
                                <option value="income" <%=transaction.type==='income' ? 'selected' : '' %>>Income
                                </option>
                                <option value="transfer" <%=transaction.type==='transfer' ? 'selected' : '' %>>Transfer
                                </option>
                                <option value="borrow" <%=transaction.type==='borrow' ? 'selected' : '' %>>Borrow (Lend
                                    from
                                    someone)
                                </option>
                                <option value="repayment" <%=transaction.type==='repayment' ? 'selected' : '' %>
                                    >Repayment (Pay
                                    back)
                                </option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <input type="number" step="0.01" class="form-control" name="amount" required
                                value="<%= transaction.amount %>">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" name="date" required
                                value="<%= transaction.date ? new Date(transaction.date).toISOString().split('T')[0] : '' %>">
                        </div>

                        <div class="mb-3" id="categoryField">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-control" name="category" placeholder="Food, Salary, etc."
                                required value="<%= transaction.category %>">
                        </div>

                        <div class="mb-3" id="natureField">
                            <label class="form-label">Nature (Expense only)</label>
                            <select class="form-select" name="nature">
                                <option value="Variable" <%=transaction.nature==='Variable' ? 'selected' : '' %>
                                    >Variable</option>
                                <option value="Fixed" <%=transaction.nature==='Fixed' ? 'selected' : '' %>>Fixed
                                </option>
                                <option value="Unwanted" <%=transaction.nature==='Unwanted' ? 'selected' : '' %>
                                    >Unwanted</option>
                                <option value="Others" <%=transaction.nature==='Others' ? 'selected' : '' %>>Others
                                </option>
                                <option value="Baby Needs" <%=transaction.nature==='Baby Needs' ? 'selected' : '' %>
                                    >Baby Needs</option>
                            </select>
                        </div>

                        <div class="mb-3 d-none" id="lenderField">
                            <label class="form-label">Lender Name</label>
                            <input type="text" class="form-control" name="lender" placeholder="Person Name"
                                value="<%= transaction.lender || '' %>">
                        </div>

                        <div class="mb-3 d-none" id="dueDateField">
                            <label class="form-label">Due Date (Optional)</label>
                            <input type="date" class="form-control" name="dueDate"
                                value="<%= transaction.dueDate ? new Date(transaction.dueDate).toISOString().split('T')[0] : '' %>">
                        </div>

                        <!-- Source (From) -->
                        <div class="mb-3">
                            <label class="form-label" id="sourceLabel">Source Account (From)</label>
                            <select class="form-select" name="sourceId" required>
                                <% sources.forEach(source=> { %>
                                    <option value="<%= source._id %>" <%=transaction.source &&
                                        transaction.source.toString()===source._id.toString() ? 'selected' : '' %>>
                                        <%= source.name %> (Bal: <%= source.balance %>)
                                    </option>
                                    <% }) %>
                            </select>
                        </div>

                        <!-- Destination (To) - for transfer -->
                        <div class="mb-3 d-none" id="destinationField">
                            <label class="form-label">Destination Account (To)</label>
                            <select class="form-select" name="destinationId">
                                <% sources.forEach(source=> { %>
                                    <option value="<%= source._id %>" <%=transaction.destination &&
                                        transaction.destination.toString()===source._id.toString() ? 'selected' : '' %>>
                                        <%= source.name %>
                                    </option>
                                    <% }) %>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" name="description"
                                value="<%= transaction.description || '' %>">
                        </div>

                        <button type="submit" class="btn btn-primary">Update Transaction</button>
                        <a href="/dashboard" class="btn btn-secondary">Cancel</a>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleFields() {
            const type = document.getElementById('type').value;
            const natureField = document.getElementById('natureField');
            const destinationField = document.getElementById('destinationField');
            const sourceLabel = document.getElementById('sourceLabel');
            const categoryField = document.getElementById('categoryField');
            const categoryInput = categoryField.querySelector('input');

            const lenderField = document.getElementById('lenderField');
            const dueDateField = document.getElementById('dueDateField');

            // Reset all visibilities first
            natureField.classList.add('d-none');
            destinationField.classList.add('d-none');
            lenderField.classList.add('d-none');
            dueDateField.classList.add('d-none');
            categoryField.classList.remove('d-none');

            if (type === 'expense') {
                natureField.classList.remove('d-none');
                sourceLabel.innerText = "Paid Via (Source)";
            } else if (type === 'income') {
                sourceLabel.innerText = "Deposit To (Source)";
            } else if (type === 'transfer') {
                destinationField.classList.remove('d-none');
                sourceLabel.innerText = "From Account";
                categoryField.classList.add('d-none');
            } else if (type === 'borrow') {
                lenderField.classList.remove('d-none');
                dueDateField.classList.remove('d-none');
                sourceLabel.innerText = "Deposit To (Source)";
            } else if (type === 'repayment') {
                lenderField.classList.remove('d-none');
                sourceLabel.innerText = "Paid Via (Source)";
            }
        }
        // Init
        toggleFields();
    </script>

    <%- include('../partials/footer') %>