<%- include('partials/header') %>

    <div class="row mb-4">
        <div class="col-md-12">
            <h2 class="text-center mb-4">
                <i class="fas fa-chart-pie me-2 text-gradient"></i>
                Financial Dashboard
            </h2>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4 g-4">
        <div class="col-md-3 col-sm-6">
            <div class="card gradient-card text-white mb-3"
                style="background: linear-gradient(135deg, #00ac69 0%, #00875a 100%); box-shadow: 0 0.25rem 0.5rem rgba(0, 172, 105, 0.2); border: none;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1 opacity-75 text-uppercase"
                                style="font-size: 0.75rem; letter-spacing: 0.5px;">Total Income</p>
                            <h3 class="mb-0 fw-bold" style="font-size: 1.75rem;">Rs.<%= totalIncome.toFixed(2) %>
                            </h3>
                        </div>
                        <div class="fs-1 opacity-50">
                            <i class="fas fa-arrow-trend-up"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card gradient-card text-white mb-3"
                style="background: linear-gradient(135deg, #e81500 0%, #c41200 100%); box-shadow: 0 0.25rem 0.5rem rgba(232, 21, 0, 0.2); border: none;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1 opacity-75 text-uppercase"
                                style="font-size: 0.75rem; letter-spacing: 0.5px;">Total Expense</p>
                            <h3 class="mb-0 fw-bold" style="font-size: 1.75rem;">Rs.<%= totalExpense.toFixed(2) %>
                            </h3>
                        </div>
                        <div class="fs-1 opacity-50">
                            <i class="fas fa-arrow-trend-down"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card gradient-card text-white mb-3"
                style="background: linear-gradient(135deg, #f4a100 0%, #d18900 100%); box-shadow: 0 0.25rem 0.5rem rgba(244, 161, 0, 0.2); border: none;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1 opacity-75 text-uppercase"
                                style="font-size: 0.75rem; letter-spacing: 0.5px;">Outstanding Debt</p>
                            <h3 class="mb-0 fw-bold" style="font-size: 1.75rem;">Rs.<%= totalDebt.toFixed(2) %>
                            </h3>
                        </div>
                        <div class="fs-1 opacity-50">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card gradient-card text-white mb-3" style="background: var(--info-gradient); cursor: pointer;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1 opacity-75">Total Balance</p>
                            <h3 class="mb-0 fw-bold">Rs.<%= totalSourceBalance.toFixed(2) %>
                            </h3>
                        </div>
                        <div class="fs-1 opacity-50">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="row mb-4">
        <div class="col-md-12 text-center">
            <a href="/transactions/add" class="btn btn-primary mx-2 mb-2">
                <i class="fas fa-plus-circle me-2"></i>Add Transaction
            </a>
            <a href="/sources/add" class="btn btn-success mx-2 mb-2">
                <i class="fas fa-university me-2"></i>Add Account
            </a>
            <a href="/sources" class="btn btn-info mx-2 mb-2">
                <i class="fas fa-cog me-2"></i>Manage Accounts
            </a>
        </div>
    </div>

    <!-- Account Balances -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-credit-card me-2"></i>Account Balances
                </div>
                <ul class="list-group list-group-flush">
                    <% sources.forEach(source=> { %>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>
                                    <%= source.name %>
                                </strong> <small>(<%= source.type %>)</small>
                                <% if(source.type==='credit_card' && source.creditLimit> 0) { %>
                                    <br><small class="text-muted">Available: Rs.<%= (source.creditLimit +
                                            source.balance).toFixed(2) %> / Limit: Rs.<%= source.creditLimit %></small>
                                    <% } %>
                            </div>
                            <span
                                class="badge <%= source.balance < 0 ? 'bg-warning text-dark' : 'bg-primary' %> rounded-pill">Rs.
                                <%= source.balance.toFixed(2) %>
                            </span>
                        </li>
                        <% }) %>
                            <% if (sources.length===0) { %>
                                <li class="list-group-item">No accounts added.</li>
                                <% } %>
                </ul>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                    <span><i class="fas fa-history me-2"></i>Recent Transactions</span>
                    <form action="/dashboard" method="GET" class="d-flex align-items-center">
                        <input type="date" name="startDate" class="form-control form-control-sm me-2"
                            onchange="this.form.submit()" title="Start Date" value="<%= query.startDate || '' %>">
                        <input type="date" name="endDate" class="form-control form-control-sm me-2"
                            onchange="this.form.submit()" title="End Date" value="<%= query.endDate || '' %>">
                        <select name="source" class="form-select form-select-sm me-2" onchange="this.form.submit()">
                            <option value="">All Sources</option>
                            <% sources.forEach(s=> { %>
                                <option value="<%= s._id %>" <%=query.source &&
                                    query.source.toString()===s._id.toString() ? 'selected' : '' %>>
                                    <%= s.name %>
                                </option>
                                <% }) %>
                        </select>
                        <select name="nature" class="form-select form-select-sm me-2" onchange="this.form.submit()">
                            <option value="">All Nature</option>
                            <option value="Fixed" <%=query.nature==='Fixed' ? 'selected' : '' %>>Fixed</option>
                            <option value="Variable" <%=query.nature==='Variable' ? 'selected' : '' %>>Variable</option>
                            <option value="Unwanted" <%=query.nature==='Unwanted' ? 'selected' : '' %>>Unwanted</option>
                            <option value="Others" <%=query.nature==='Others' ? 'selected' : '' %>>Others</option>
                            <option value="Baby Needs" <%=query.nature==='Baby Needs' ? 'selected' : '' %>>Baby Needs
                            </option>
                        </select>
                    </form>
                </div>
                <div class="card-body bg-light py-2">
                    <div class="d-flex justify-content-between">
                        <span><strong>Filtered:</strong></span>
                        <span class="text-success">Income: Rs.<%= filteredIncome.toFixed(2) %></span>
                        <span class="text-danger">Expense: Rs.<%= filteredExpense.toFixed(2) %></span>
                    </div>
                </div>
                <ul class="list-group list-group-flush">
                    <% transactions.forEach(trx=> { %>
                        <li class="list-group-item">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 fw-bold">
                                        <i
                                            class="fas <%= (trx.type === 'income' || trx.type === 'borrow') ? 'fa-arrow-circle-up text-success' : 'fa-arrow-circle-down text-danger' %> me-2"></i>
                                        <%= trx.category %>
                                    </h6>
                                    <p class="mb-1 small text-muted">
                                        <%= trx.description %>
                                    </p>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        <%= new Date(trx.date).toLocaleDateString() %> |
                                            <i class="fas fa-tag me-1"></i>
                                            <%= trx.type %>
                                    </small>
                                </div>
                                <div class="text-end">
                                    <div class="mb-2">
                                        <strong
                                            class="<%= (trx.type === 'income' || trx.type === 'borrow') ? 'text-success' : 'text-danger' %>">
                                            <%= (trx.type==='income' || trx.type==='borrow' ) ? '+' : '-' %>Rs.<%=
                                                    trx.amount.toFixed(2) %>
                                        </strong>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/transactions/edit/<%= trx._id %>"
                                            class="btn btn-outline-secondary btn-sm" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form action="/transactions/delete/<%= trx._id %>" method="POST"
                                            class="d-inline" onsubmit="return confirm('Delete this transaction?');">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                        </li>
                        <% }) %>
                            <% if (transactions.length===0) { %>
                                <li class="list-group-item">No records found.</li>
                                <% } %>
                </ul>
                <div class="card-footer text-center">
                    <a href="/transactions" class="btn btn-outline-primary btn-sm">View Detailed History</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-2"></i>Income Distribution
                </div>
                <div class="card-body" style="height: 300px; position: relative;">
                    <canvas id="incomeChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-2"></i>Expense Distribution
                </div>
                <div class="card-body" style="height: 300px; position: relative;">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Use specific version of Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        try {
            // Data from backend
            // Use <%- %> (no space) for raw output
            const incomeData = <% - (typeof incomeByCategory !== 'undefined' && incomeByCategory) ? JSON.stringify(incomeByCategory) : '[]' %>;
            const expenseData = <% - (typeof expenseByCategory !== 'undefined' && expenseByCategory) ? JSON.stringify(expenseByCategory) : '[]' %>;

            console.log('Income Data:', incomeData);
            console.log('Expense Data:', expenseData);

            // Helper to generate colors
            function generateColors(count) {
                const colors = [];
                for (let i = 0; i < count; i++) {
                    const hue = (i * 137.508) % 360;
                    colors.push(`hsla(${hue}, 70%, 60%, 0.7)`);
                }
                return colors;
            }

            // Common Options
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            };

            // Income Chart
            if (incomeData && incomeData.length > 0) {
                const incomeCtx = document.getElementById('incomeChart').getContext('2d');
                new Chart(incomeCtx, {
                    type: 'pie',
                    data: {
                        labels: incomeData.map(d => d._id),
                        datasets: [{
                            data: incomeData.map(d => d.total),
                            backgroundColor: generateColors(incomeData.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        ...commonOptions,
                        plugins: {
                            ...commonOptions.plugins,
                            title: {
                                display: true,
                                text: 'Income by Category'
                            }
                        }
                    }
                });
            } else {
                const container = document.getElementById('incomeChart').parentElement;
                container.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted">No income data available</div>';
                container.style.height = '300px'; // Ensure height for message
            }

            // Expense Chart
            if (expenseData && expenseData.length > 0) {
                const expenseCtx = document.getElementById('expenseChart').getContext('2d');
                new Chart(expenseCtx, {
                    type: 'pie',
                    data: {
                        labels: expenseData.map(d => d._id),
                        datasets: [{
                            data: expenseData.map(d => d.total),
                            backgroundColor: generateColors(expenseData.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        ...commonOptions,
                        plugins: {
                            ...commonOptions.plugins,
                            title: {
                                display: true,
                                text: 'Expense by Category'
                            }
                        }
                    }
                });
            } else {
                const container = document.getElementById('expenseChart').parentElement;
                container.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted">No expense data available</div>';
                container.style.height = '300px';
            }
        } catch (error) {
            console.error("Error rendering charts:", error);
        }
    </script>

    <%- include('partials/footer') %>