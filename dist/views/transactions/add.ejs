<%- include('../partials/header') %>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card mt-4">
                <div class="card-header">Add Transaction</div>
                <div class="card-body">
                    <form action="/transactions/add" method="POST">
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" name="type" id="type" onchange="toggleFields()">
                                <option value="expense">Expense</option>
                                <option value="income">Income</option>
                                <option value="transfer">Transfer</option>
                                <option value="borrow">Borrow (Lend from someone)</option>
                                <option value="repayment">Repayment (Pay back)</option>
                                <option value="lend">Given Loan (Lend to someone)</option>
                                <option value="loan_repayment">Loan Repayment (Received)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <input type="number" step="0.01" class="form-control" name="amount" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" name="date" required
                                value="<%= new Date().toISOString().split('T')[0] %>">
                        </div>

                        <div class="mb-3" id="categoryField">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="categorySelect" onchange="checkCategory(this)">
                                <option value="" disabled selected>Select Category</option>
                                <% categories.forEach(cat=> { %>
                                    <option value="<%= cat.name %>" data-type="<%= cat.type %>">
                                        <%= cat.name %>
                                    </option>
                                    <% }) %>
                                        <option value="Other">Other...</option>
                            </select>
                            <input type="text" class="form-control mt-2" id="categoryInput" name="category"
                                placeholder="Enter category" style="display: none;">
                        </div>

                        <div class="mb-3" id="natureField">
                            <label class="form-label">Nature (Expense only)</label>
                            <select class="form-select" name="nature">
                                <option value="Variable">Variable</option>
                                <option value="Fixed">Fixed</option>
                                <option value="Unwanted">Unwanted</option>
                                <option value="Others">Others</option>
                                <option value="Baby Needs">Baby Needs</option>
                            </select>
                        </div>

                        <div class="mb-3 d-none" id="lenderField">
                            <label class="form-label">Lender Name</label>
                            <input type="text" class="form-control" name="lender" placeholder="Person Name">
                        </div>

                        <div class="mb-3 d-none" id="borrowerField">
                            <label class="form-label">Borrower Name (Person taking loan)</label>
                            <input type="text" class="form-control" name="borrower" placeholder="Person Name">
                        </div>

                        <div class="mb-3 d-none" id="dueDateField">
                            <label class="form-label">Due Date (Optional)</label>
                            <input type="date" class="form-control" name="dueDate">
                        </div>

                        <!-- Source (From) -->
                        <div class="mb-3">
                            <label class="form-label" id="sourceLabel">Source Account (From)</label>
                            <select class="form-select" name="sourceId" required>
                                <% sources.forEach(source=> { %>
                                    <option value="<%= source._id %>">
                                        <%= source.name %> (Bal: <%= source.balance %>)
                                    </option>
                                    <% }) %>
                            </select>
                        </div>

                        <!-- Destination (To) - for transfer -->
                        <div class="mb-3 d-none" id="destinationField">
                            <label class="form-label">Destination Account (To)</label>
                            <select class="form-select" name="destinationId">
                                <% sources.forEach(source=> { %>
                                    <option value="<%= source._id %>">
                                        <%= source.name %>
                                    </option>
                                    <% }) %>
                            </select>
                        </div>

                        <div class="mb-3 d-none" id="transferFeeField">
                            <label class="form-label">Transfer Fee</label>
                            <input type="number" step="0.01" class="form-control" name="transferFee"
                                placeholder="Fee amount">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" name="description">
                        </div>

                        <button type="submit" class="btn btn-primary">Save Transaction</button>
                        <a href="/dashboard" class="btn btn-secondary">Cancel</a>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleFields() {
            const type = document.getElementById('type').value;
            const natureField = document.getElementById('natureField');
            const destinationField = document.getElementById('destinationField');
            const sourceLabel = document.getElementById('sourceLabel');
            const categoryField = document.getElementById('categoryField');
            const categoryInput = document.getElementById('categoryInput');
            const categorySelect = document.getElementById('categorySelect');
            const lenderField = document.getElementById('lenderField');
            const borrowerField = document.getElementById('borrowerField');
            const dueDateField = document.getElementById('dueDateField');
            const transferFeeField = document.getElementById('transferFeeField');

            // Reset all visibilities
            natureField.classList.add('d-none');
            destinationField.classList.add('d-none');
            lenderField.classList.add('d-none');
            borrowerField.classList.add('d-none');
            dueDateField.classList.add('d-none');
            transferFeeField.classList.add('d-none');
            categoryField.classList.remove('d-none');

            // Logic
            if (type === 'expense') {
                natureField.classList.remove('d-none');
                sourceLabel.innerText = "Paid Via (Source)";
                filterCategories('expense');
            } else if (type === 'income') {
                sourceLabel.innerText = "Deposit To (Source)";
                filterCategories('income');
            } else if (type === 'transfer') {
                destinationField.classList.remove('d-none');
                transferFeeField.classList.remove('d-none');
                sourceLabel.innerText = "From Account";
                categoryField.classList.add('d-none');
                categoryInput.value = "Transfer";
            } else if (type === 'borrow') {
                lenderField.classList.remove('d-none');
                dueDateField.classList.remove('d-none');
                sourceLabel.innerText = "Deposit To (Source)";
                categoryInput.value = "Loan/Debt";
            } else if (type === 'repayment') {
                lenderField.classList.remove('d-none');
                sourceLabel.innerText = "Paid Via (Source)";
                categoryInput.value = "Debt Repayment";
            } else if (type === 'lend') {
                borrowerField.classList.remove('d-none');
                sourceLabel.innerText = "Paid Via (Source)";
                categoryInput.value = "Given Loan";
            } else if (type === 'loan_repayment') {
                borrowerField.classList.remove('d-none');
                sourceLabel.innerText = "Deposit To (Source)";
                categoryInput.value = "Received Payment";
            }
        }

        function checkCategory(select) {
            const input = document.getElementById('categoryInput');
            if (select.value === 'Other') {
                input.style.display = 'block';
                input.value = '';
                input.required = true;
                input.focus();
            } else {
                input.style.display = 'none';
                input.value = select.value;
                input.required = true; // Still required, holds value
            }
        }

        function filterCategories(type) {
            const select = document.getElementById('categorySelect');
            const options = select.options;
            let found = false;
            for (let i = 0; i < options.length; i++) {
                const opt = options[i];
                if (opt.value === 'Other' || opt.value === '') {
                    opt.style.display = 'block';
                } else {
                    const catType = opt.getAttribute('data-type');
                    if (catType === type) {
                        opt.style.display = 'block';
                        found = true;
                    } else {
                        opt.style.display = 'none';
                    }
                }
            }
            select.selectedIndex = 0;
            checkCategory(select);
        }
        // Init
        toggleFields();
    </script>

    <%- include('../partials/footer') %>